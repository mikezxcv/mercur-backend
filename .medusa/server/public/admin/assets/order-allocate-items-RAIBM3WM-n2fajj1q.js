import{g as J}from"./chunk-WKOPGFW5-Di_6cJlP.js";import{K as Z}from"./chunk-6HTZNHPT-BHsf02UK.js";import{R as N,u as ee}from"./chunk-AERWK3TJ-2NOSGJWi.js";import{ar as se,at as Q,aw as te,aF as ae,ac as ie,dn as le,j as e,b as P,K as ne,r as g,dT as re,ay as ce,az as oe,dU as de,q as ue,dr as xe,t as K,Q as W,H as me,X as x,av as I,Y as V,B as H,dh as z,ap as fe,_ as R,I as ve,c2 as he}from"./index-Bxfpjf1r.js";import{C as pe}from"./component-vCNd8WjI.js";import{A as je}from"./alert-BTkRE3TZ.js";var ye=se({location_id:Q(),quantity:te(Q(),ae().or(Q()))});function X(s){const i=s.variant;return i?!!i.inventory_items.length&&i.inventory_items.length>1||i.inventory_items.length===1&&i.inventory_items[0].required_quantity>1:!1}function ge({item:s,form:i,locationId:o,onQuantityChange:h}){var j,_,q,w,$,l;const{t:u}=P(),f=s.variant,p=((j=s.variant)==null?void 0:j.inventory)||[],[S,F]=g.useState(!1),v=W({control:i.control,name:"quantity"}),c=X(s),{availableQuantity:y,inStockQuantity:m}=g.useMemo(()=>{var r,a;if(!f||!o)return{};const t=(a=(r=p[0])==null?void 0:r.location_levels)==null?void 0:a.find(n=>n.location_id===o);return t?{availableQuantity:t.available_quantity,inStockQuantity:t.stocked_quantity}:{}},[f,o]),T=!c&&y&&v[`${s.id}-${(_=s.variant)==null?void 0:_.inventory[0].id}`]&&v[`${s.id}-${(q=s.variant)==null?void 0:q.inventory[0].id}`]>y,L=0,M=Math.min(J(s),y||Number.MAX_SAFE_INTEGER);return e.jsxs("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 min-w-[720px] divide-y divide-dashed rounded-xl",children:[e.jsxs("div",{className:"flex items-center gap-x-3 p-3 text-sm",children:[e.jsx("div",{className:"flex flex-1 items-center",children:e.jsxs("div",{className:"flex items-center gap-x-3",children:[T&&e.jsx(z,{className:"text-ui-fg-error"}),e.jsx(fe,{src:s.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex flex-row",children:[e.jsx(R,{className:"txt-small flex",as:"span",weight:"plus",children:s.product_title}),s.variant_sku&&e.jsxs("span",{className:"text-ui-fg-subtle",children:[" ","(",s.variant_sku,")"]}),c&&e.jsx(pe,{className:"text-ui-fg-muted ml-2 overflow-visible pt-[2px]"})]}),e.jsx(R,{as:"div",className:"text-ui-fg-subtle txt-small",children:s.title})]})]})}),e.jsxs("div",{className:ve("flex flex-1 items-center gap-x-3",c?"justify-end":"justify-between"),children:[!c&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"txt-small flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:u("labels.available")}),e.jsxs("span",{className:"text-ui-fg-muted",children:[y||"-",y&&!c&&v[`${s.id}-${(w=s.variant)==null?void 0:w.inventory[0].id}`]&&e.jsxs("span",{className:"text-ui-fg-error txt-small ml-1",children:["-",v[`${s.id}-${($=s.variant)==null?void 0:$.inventory[0].id}`]]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"txt-small flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:u("labels.inStock")}),e.jsx("span",{className:"text-ui-fg-muted",children:m||"-"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"text-ui-fg-subtle txt-small mr-2 flex flex-row items-center gap-2",children:[e.jsx(x.Field,{control:i.control,name:c?`quantity.${s.id}-`:`quantity.${s.id}-${(l=s.variant)==null?void 0:l.inventory[0].id}`,rules:{required:!c,min:!c&&L,max:M},render:({field:t})=>e.jsx(x.Item,{children:e.jsx(x.Control,{children:e.jsx(V,{className:"bg-ui-bg-base txt-small w-[46px] rounded-lg text-right [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",type:"number",...t,disabled:!o,onChange:r=>{var n;const a=r.target.value===""?null:Number(r.target.value);h((n=s.variant)==null?void 0:n.inventory[0],s,c,a,!0)}})})})})," ","/ ",s.quantity," ",u("fields.qty")]})]})]})]}),c&&e.jsx("div",{className:"px-4 py-2",children:e.jsxs("div",{onClick:()=>F(t=>!t),className:"flex items-center gap-x-2",children:[e.jsx(he,{style:{transform:`rotate(${S?-90:0}deg)`},className:"text-ui-fg-muted -mt-[1px]"}),e.jsx("span",{className:"txt-small text-ui-fg-muted cursor-pointer",children:u("orders.allocateItems.consistsOf",{num:p.length})})]})}),S&&f.inventory.map((t,r)=>{const a=t.location_levels.find(d=>d.location_id===o),n=!!v[`${s.id}-${t.id}`]&&v[`${s.id}-${t.id}`]>a.available_quantity;return e.jsxs("div",{className:"txt-small flex items-center gap-x-3 p-4",children:[e.jsxs("div",{className:"flex flex-1 flex-row items-center gap-3",children:[n&&e.jsx(z,{className:"text-ui-fg-error"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle",children:t.title}),e.jsx("span",{className:"text-ui-fg-muted",children:u("orders.allocateItems.requires",{num:f.inventory_items[r].required_quantity})})]})]}),e.jsxs("div",{className:"flex flex-1 flex-row justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"txt-small flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:u("labels.available")}),e.jsxs("span",{className:"text-ui-fg-muted",children:[(a==null?void 0:a.available_quantity)||"-",(a==null?void 0:a.available_quantity)&&v[`${s.id}-${t.id}`]&&e.jsxs("span",{className:"text-ui-fg-error txt-small ml-1",children:["-",v[`${s.id}-${t.id}`]]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"txt-small flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:u("labels.inStock")}),e.jsx("span",{className:"text-ui-fg-muted",children:(a==null?void 0:a.stocked_quantity)||"-"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-ui-border-strong block h-[12px] w-[1px]"}),e.jsxs("div",{className:"text-ui-fg-subtle txt-small mr-1 flex flex-row items-center gap-2",children:[e.jsx(x.Field,{control:i.control,name:`quantity.${s.id}-${t.id}`,rules:{required:!0,min:0,max:a==null?void 0:a.available_quantity},render:({field:d})=>e.jsx(x.Item,{children:e.jsx(x.Control,{children:e.jsx(V,{className:"bg-ui-bg-base txt-small w-[46px] rounded-lg text-right [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",type:"number",...d,disabled:!o,onChange:b=>{const A=b.target.value===""?null:Number(b.target.value);h(t,s,c,A)}})})})}),"/"," ",s.quantity*f.inventory_items[r].required_quantity," ",u("fields.qty")]})]})]})]},t.id)})]})}function be({order:s}){var q,w,$;const{t:i}=P(),{handleSuccess:o}=ee(),h=ne(),[u,f]=g.useState(!1),[p,S]=g.useState(""),{mutateAsync:F,isPending:v}=re(),c=g.useMemo(()=>s.items.filter(l=>{var t,r;return((t=l.variant)==null?void 0:t.manage_inventory)&&((r=l.variant)==null?void 0:r.inventory.length)&&l.quantity-l.detail.fulfilled_quantity>0}),[s.items]),y=g.useMemo(()=>c.filter(l=>l.variant_title.toLowerCase().includes(p)||l.product_title.toLowerCase().includes(p)),[c,p]);c.length;const m=ce({defaultValues:{location_id:"",quantity:B(c)},resolver:oe(ye)}),{stock_locations:T=[]}=de(),L=m.handleSubmit(async l=>{try{const t=Object.entries(l.quantity).filter(([n])=>!n.endsWith("-")).map(([n,d])=>[...n.split("-"),d]);if(t.some(n=>n[2]==="")){m.setError("root.quantityNotAllocated",{type:"manual",message:i("orders.allocateItems.error.quantityNotAllocated")});return}const r=t.map(([n,d,b])=>F({location_id:l.location_id,inventory_item_id:d,line_item_id:n,quantity:Number(b)}).then(()=>({success:!0,inventory_item_id:d})).catch(()=>({success:!1,inventory_item_id:d}))),a=await Promise.all(r);if(await ue.invalidateQueries({queryKey:xe.details()}),o(`/orders/${s.id}`),a.some(n=>!n.success)){const n=a.filter(d=>!d.success).map(d=>d.inventory_item_id).join(", ");K.error(i("general.error"),{description:i("orders.allocateItems.toast.error",{items:n}),dismissLabel:i("actions.close")})}}catch(t){K.error(i("general.error"),{description:t.message,dismissLabel:i("actions.close")})}}),M=(l,t,r,a,n)=>{var A;let d=!1;const b=n&&r?`quantity.${t.id}-`:`quantity.${t.id}-${l.id}`;if(m.setValue(b,a),a){const k=l.location_levels.find(C=>C.location_id===j);k&&k.available_quantity<a&&(d=!0)}if(r&&!n&&m.resetField(`quantity.${t.id}-`,{defaultValue:""}),r&&n){const k=c.find(C=>C.id===t.id);(A=k.variant)==null||A.inventory_items.forEach((C,G)=>{var O;const U=a||0,E=(O=k.variant)==null?void 0:O.inventory[G];if(m.setValue(`quantity.${t.id}-${E.id}`,U*C.required_quantity),a){const D=E==null?void 0:E.location_levels.find(Y=>Y.location_id===j);D&&D.available_quantity<a&&(d=!0)}})}m.clearErrors("root.quantityNotAllocated"),f(d)},j=W({name:"location_id",control:m.control});g.useEffect(()=>{j&&m.setValue("quantity",B(c))},[j]);const _=($=(w=(q=m.formState.errors)==null?void 0:q.root)==null?void 0:w.quantityNotAllocated)==null?void 0:$.message;return e.jsx(N.Form,{form:m,children:e.jsxs(Z,{onSubmit:L,className:"flex h-full flex-col overflow-hidden",children:[e.jsx(N.Header,{}),e.jsx(N.Body,{className:"flex h-full w-full flex-col items-center divide-y overflow-y-auto",children:e.jsx("div",{className:"flex size-full flex-col items-center overflow-auto p-16",children:e.jsx("div",{className:"flex w-full max-w-[736px] flex-col justify-center px-2 pb-2",children:e.jsxs("div",{className:"flex flex-col gap-8 divide-y divide-dashed",children:[e.jsx(me,{children:i("orders.allocateItems.title")}),e.jsxs("div",{className:"flex-1 divide-y divide-dashed pt-8",children:[e.jsx(x.Field,{control:m.control,name:"location_id",render:({field:{onChange:l,ref:t,...r}})=>e.jsxs(x.Item,{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(x.Label,{children:i("fields.location")}),e.jsx(x.Hint,{children:i("orders.allocateItems.locationDescription")})]}),e.jsx("div",{className:"flex-1",children:e.jsx(x.Control,{children:e.jsxs(I,{dir:h,onValueChange:l,...r,children:[e.jsx(I.Trigger,{className:"bg-ui-bg-base",ref:t,children:e.jsx(I.Value,{})}),e.jsx(I.Content,{children:T.map(a=>e.jsx(I.Item,{value:a.id,children:a.name},a.id))})]})})})]}),e.jsx(x.ErrorMessage,{})]})}),e.jsxs(x.Item,{className:"mt-8 pt-8",children:[e.jsxs("div",{className:"flex flex-row items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(x.Label,{children:i("orders.allocateItems.itemsToAllocate")}),e.jsx(x.Hint,{children:i("orders.allocateItems.itemsToAllocateDesc")})]}),e.jsx("div",{className:"flex-1",children:e.jsx(V,{value:p,onChange:l=>S(l.target.value),placeholder:i("orders.allocateItems.search"),autoComplete:"off",type:"search"})})]}),_&&e.jsx(je,{className:"mb-4",dismissible:!0,variant:"error",children:_}),e.jsx("div",{className:"flex flex-col gap-y-1",children:y.map(l=>e.jsx(ge,{form:m,item:l,locationId:j,onQuantityChange:M},l.id))})]})]})]})})})}),e.jsx(N.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(N.Close,{asChild:!0,children:e.jsx(H,{size:"small",variant:"secondary",children:i("actions.cancel")})}),e.jsx(H,{size:"small",type:"submit",isLoading:v,disabled:!j||u,children:i("orders.allocateItems.action")})]})})]})})}function B(s){const i={};return s.forEach(o=>{var u,f;const h=X(o);i[h?`${o.id}-`:`${o.id}-${(u=o.variant)==null?void 0:u.inventory[0].id}`]="",h&&((f=o.variant)==null||f.inventory.forEach(p=>{i[`${o.id}-${p.id}`]=""}))}),i}function Ce(){const{id:s}=ie(),{order:i,isLoading:o,isError:h,error:u}=le(s,{fields:"currency_code,*items,*items.variant,+items.variant.product.title,*items.variant.inventory,*items.variant.inventory.location_levels,*items.variant.inventory_items,*shipping_address"});if(h)throw u;const f=!o&&i;return e.jsx(N,{children:f&&e.jsx(be,{order:i})})}export{Ce as Component};
